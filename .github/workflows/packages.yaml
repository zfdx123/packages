name: Sync Packages

on:
  workflow_dispatch:

jobs:
  sync-packages:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4
      with:
        ref: master
        fetch-depth: 0

    - name: Set up Git config
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Switch to or create 'packages' branch
      run: |
        git fetch origin packages || true
        git checkout packages 2>/dev/null || git checkout -b packages
        git pull origin packages || true
        git push --set-upstream origin packages || true

    - name: Clean workspace (keep .git)
      run: |
        find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

    # === 以下为同步多个上游仓库 ===

    - name: Sync sbwml/luci-app-mosdns
      run: |
        git clone --depth 1 --filter=blob:none --sparse https://github.com/sbwml/luci-app-mosdns src-sbwml
        cd src-sbwml
        git sparse-checkout set luci-app-mosdns mosdns v2dat
        cd ..
        rm -rf src-sbwml/.github
        cp -r src-sbwml/* .
        rm -rf src-sbwml

    - name: Sync xiaorouji/openwrt-passwall-packages
      run: |
        git clone --depth 1 --filter=blob:none https://github.com/xiaorouji/openwrt-passwall-packages src-passwall-pkg
        rm -rf src-passwall-pkg/.github
        cp -r src-passwall-pkg/* .
        rm -rf src-passwall-pkg

    - name: Sync xiaorouji/openwrt-passwall
      run: |
        git clone --depth 1 --filter=blob:none --sparse https://github.com/xiaorouji/openwrt-passwall src-passwall
        cd src-passwall
        git sparse-checkout set luci-app-passwall
        cd ..
        rm -rf src-passwall/.github
        cp -r src-passwall/* .
        rm -rf src-passwall
        
    - name: Sync zfdx123/luci-app-adguard
      run: |
        git clone --depth 1 --filter=blob:none --sparse https://github.com/zfdx123/luci-app-adguard src-adguard
        cd src-adguard
        git sparse-checkout set luci-app-adguard
        cd ..
        rm -rf src-adguard/.github
        cp -r src-adguard/* .
        rm -rf src-adguard

    - name: Sync zfdx123/msd_lite
      run: |
        git clone --depth 1 --filter=blob:none --sparse https://github.com/zfdx123/msd_lite src-msd_lite
        cd src-msd_lite
        git sparse-checkout set luci-app-msd_lite msd_lite
        cd ..
        rm -rf src-msd_lite/.github
        cp -r src-msd_lite/* .
        rm -rf src-msd_lite
        
    # === 注意：以下两个仓库是根目录直接是项目，无需 sparse-checkout ===

    - name: Sync jerrykuku/luci-theme-argon
      run: |
        git clone --depth 1 https://github.com/jerrykuku/luci-theme-argon src-argon
        rm -rf src-argon/.github
        cp -r src-argon/* .
        rm -rf src-argon

    - name: Sync jerrykuku/luci-app-argon-config
      run: |
        git clone --depth 1 https://github.com/jerrykuku/luci-app-argon-config src-argon-config
        rm -rf src-argon-config/.github
        cp -r src-argon-config/* .
        rm -rf src-argon-config

    # === 提交推送 ===
    - name: Commit and push changes
      run: |
        git add .
        if git diff --cached --quiet; then
          echo "No changes to commit."
        else
          git commit -m "chore: sync packages"
          git push origin packages
        fi
